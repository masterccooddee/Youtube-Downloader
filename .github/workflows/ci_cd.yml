name: Auto Update yt-dlp & Build Windows EXE

on:
  schedule:
    - cron: '0 0,12 * * *'  # 每週日 UTC 時間 00:00, 12:00 自動觸發
  workflow_dispatch:      # 允許手動觸發

permissions:
  contents: write

jobs:
    check_version:
        runs-on: ubuntu-latest
        outputs:
            is_needed: ${{ steps.check.outputs.UPDATE_NEEDED }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6
            
            - name: Check Versions (No uv required)
              id: check
              run: |
                    # 1. 從 PyPI API 取得最新版本
                    LATEST=$(curl -s https://pypi.org/pypi/yt-dlp/json | jq -r .info.version)
                    echo "Latest version: $LATEST"
                    
                    # 2. 從 uv.lock 檔案中讀取目前版本 (使用 grep/sed 提取，不需 uv)
                    # 邏輯: 找到 name = "yt-dlp" 的下一行通常是 version
                    CURRENT=$(grep -A 2 'name = "yt-dlp"' uv.lock | grep 'version' | head -n 1 | cut -d '"' -f 2)
                    echo "Current lock version: $CURRENT"
                    
                    # 3. 比對兩者
                    if [ "$LATEST" != "$CURRENT" ]; then
                        echo "版本不同，需要更新！"
                        echo "UPDATE_NEEDED=true" >> $GITHUB_OUTPUT

                        echo "UPDATE_NEEDED=true" >> $GITHUB_ENV
                        echo "LATEST_VERSION=$LATEST" >> $GITHUB_ENV
                    else
                        echo "版本相同，無需動作。"
                        echo "UPDATE_NEEDED=false" >> $GITHUB_OUTPUT
                    fi
            - name: Install uv
              if: env.UPDATE_NEEDED == 'true'
              uses: astral-sh/setup-uv@v7

            - name: Update uv.lock
              if: env.UPDATE_NEEDED == 'true'
              # 只更新 yt-dlp，不影響其他套件
              run: uv lock --upgrade-package yt-dlp[default]

            - name: Commit and Push
              if: env.UPDATE_NEEDED == 'true'
              run: |
                git config --global user.name "github-actions[bot]"
                git config --global user.email "github-actions[bot]@users.noreply.github.com"
                
                git add uv.lock
                git commit -m "Auto-update yt-dlp to ${{ env.LATEST_VERSION }}"
                echo "Pushing changes..."
                git push
    build_exe:
        needs: check_version
        if: needs.check_version.outputs.is_needed == 'true'
        runs-on: windows-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v6
              with:
                ref: main

            - name: Install uv
              uses: astral-sh/setup-uv@v7
              with:
                enable-cache: true
                python-version: "3.13"

            - name: Install dependencies
              # 使用 sync 確保安裝的是 uv.lock 中紀錄的確切版本 (包含剛更新的 yt-dlp)
              run: uv sync

            - name: Build with flet pack
              env:
                    PYTHONIOENCODING: utf-8
                    PYTHONUTF8: 1
              run: uv run flet pack main.py --name "YouTube下載器" --add-data "assets;assets" --icon "assets/ytdownload.ico"

            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                name: YouTube-Downloader-Windows
                path: dist/YouTube下載器.exe
                if-no-files-found: error